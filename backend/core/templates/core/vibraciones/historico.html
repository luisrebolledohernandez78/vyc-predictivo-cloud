<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ titulo }} - VYC Predictivo Cloud</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    {% load static %}
    <link rel="stylesheet" href="{% static 'css/sidebar.css' %}">
    <style>
    .main-content {
        flex: 1;
        padding: 25px;
    }

    .breadcrumb-container {
        margin-bottom: 15px;
        padding: 0;
    }

    .breadcrumb {
        background: transparent;
        padding: 0;
        margin: 0;
        font-size: 1em;
    }

    .breadcrumb-item a {
        color: #667eea;
        text-decoration: none;
    }

    .breadcrumb-item a:hover {
        text-decoration: underline;
    }

    .breadcrumb-item.active {
        color: #999;
    }

    .content {
        border-radius: 12px;
        padding: 25px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
        background-color: white;
    }

    .content.content-vibraciones {
        background-image: 
            url("data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='200' height='100'%3E%3Cpath d='M0,50 Q50,30 100,50 T200,50' stroke='%23667eea' stroke-width='1' fill='none' opacity='0.1'/%3E%3Cpath d='M0,60 Q50,40 100,60 T200,60' stroke='%23667eea' stroke-width='1' fill='none' opacity='0.1'/%3E%3Cpath d='M0,40 Q50,20 100,40 T200,40' stroke='%23667eea' stroke-width='1' fill='none' opacity='0.1'/%3E%3Cpath d='M0,70 Q50,50 100,70 T200,70' stroke='%23667eea' stroke-width='1' fill='none' opacity='0.1'/%3E%3Ccircle cx='100' cy='50' r='8' fill='%23667eea' opacity='0.08'/%3E%3C/svg%3E"),
            linear-gradient(white, white);
        background-repeat: repeat;
        background-size: 200px 100px;
    }

    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 25px;
        padding-bottom: 15px;
        border-bottom: 2px solid #e5e7eb;
    }

    .section-header h2 {
        margin: 0;
        color: #111;
        font-size: 1.4em;
        font-weight: 700;
    }

    .section-header p {
        margin: 5px 0 0 0;
        color: #666;
        font-size: 0.95em;
    }

    .btn-back {
        padding: 10px 16px;
        background-color: #6b7280;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 500;
        font-size: 0.95em;
        transition: all 0.3s ease;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 6px;
    }

    .btn-back:hover {
        background-color: #4b5563;
        color: white;
    }

    /* Table Styles */
    .table-responsive {
        border-radius: 8px;
        overflow: hidden;
    }

    .table {
        margin-bottom: 0;
    }

    .table thead th {
        background-color: #f3f4f6;
        color: #374151;
        font-weight: 600;
        border-right: 1px solid #d1d5db;
        padding: 12px 10px;
        font-size: 0.9em;
    }

    .table thead th:last-child {
        border-right: none;
    }

    .table tbody td {
        border-right: 1px solid #e5e7eb;
        padding: 10px 10px;
        vertical-align: middle;
    }

    .table tbody td:last-child {
        border-right: none;
    }

    .table tbody tr {
        border-bottom: 1px solid #e5e7eb;
    }

    .table tbody tr:hover {
        background-color: #f9fafb;
    }

    .col-numero {
        width: 40px;
        text-align: center;
        font-weight: 600;
        color: #667eea;
    }

    .col-area {
        width: 140px;
        text-align: center;
    }

    .col-equipo {
        width: 140px;
    }

    .col-activo {
        width: 140px;
    }

    .col-fecha {
        width: 132px;
        text-align: center;
        padding: 8px !important;
    }

    .area-badge {
        display: inline-block;
        padding: 3px 8px;
        border-radius: 20px;
        font-size: 0.8em;
        font-weight: 600;
        color: white;
    }

    .area-badge.aserradero {
        background-color: #27ae60;
    }

    .area-badge.elaborado {
        background-color: #d4af37;
        color: #333;
    }

    .area-badge.caldera {
        background-color: #e53935;
    }

    .estado-badge {
        display: inline-block;
        padding: 6px 12px;
        border-radius: 4px;
        font-size: 0.85em;
        font-weight: 600;
        text-align: center;
        min-width: 125px;
        color: white;
        white-space: nowrap;
    }

    .estado-badge.bueno {
        background-color: #22c55e;
        color: white;
    }

    .estado-badge.observacion {
        background-color: #fef08a;
        color: #333;
    }

    .estado-badge.alarma {
        background-color: #fb923c;
        color: white;
    }

    .estado-badge.falla {
        background-color: #dc2626;
        color: white;
    }

    .estado-badge.sin_medicion {
        background-color: #d1d5db;
        color: #374151;
    }

    .sin-datos {
        color: #999;
        font-style: italic;
    }
    </style>
</head>
<body>
    <!-- SIDEBAR -->
    {% include 'core/sidebar.html' %}

    <!-- MAIN CONTENT -->
    <main class="main-content">
        <section class="content {% if modulo %}content-{{ modulo }}{% endif %}">

            <!-- Breadcrumb -->
            <nav aria-label="breadcrumb" class="breadcrumb-container">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{% url 'vibraciones' %}">Vibraciones</a></li>
                    <li class="breadcrumb-item"><a href="{% url 'sucursales_vibraciones' cliente.id %}">{{ cliente.nombre }}</a></li>
                    <li class="breadcrumb-item"><a href="{% url 'areas_vibraciones' cliente.id sucursal.id %}">{{ sucursal.nombre }}</a></li>
                    <li class="breadcrumb-item active">Histórico</li>
                </ol>
            </nav>

            <!-- Header Section -->
            <div class="section-header">
                <div>
                    <h2>{{ titulo }}</h2>
                    <p>{{ descripcion }}</p>
                </div>
            </div>

            <!-- Estadísticas -->
            <div style="display: flex; gap: 20px; margin-bottom: 25px; flex-wrap: wrap;">
                <div style="flex: 1; min-width: 150px; padding: 15px; background: #f3f4f6; border-radius: 8px; border-left: 4px solid #667eea;">
                    <div style="font-size: 0.9em; color: #666; font-weight: 600; margin-bottom: 5px;">
                        <i class="fas fa-cogs"></i> Equipos
                    </div>
                    <div style="font-size: 1.8em; font-weight: 700; color: #667eea;">
                        {{ total_equipos }}
                    </div>
                </div>
                <div style="flex: 1; min-width: 150px; padding: 15px; background: #f3f4f6; border-radius: 8px; border-left: 4px solid #22c55e;">
                    <div style="font-size: 0.9em; color: #666; font-weight: 600; margin-bottom: 5px;">
                        <i class="fas fa-microchip"></i> Activos
                    </div>
                    <div style="font-size: 1.8em; font-weight: 700; color: #22c55e;">
                        {{ total_activos }}
                    </div>
                </div>
            </div>

            <!-- Table -->
            <div class="table-responsive">
                <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                    <a href="{% url 'equipos_totales_vibraciones' cliente.id sucursal.id %}" class="btn-back">
                        <i class="fas fa-arrow-left"></i> Volver
                    </a>
                </div>

                <table class="table">
                    <thead>
                        <tr>
                            <th class="col-numero">#</th>
                            <th class="col-area text-center">Área</th>
                            <th class="col-equipo">Equipo</th>
                            <th class="col-activo">Activo</th>
                            <th class="col-fecha text-center">15/01/2026</th>
                            <th class="col-fecha text-center">16/01/2026</th>
                            <th class="col-fecha text-center">17/01/2026</th>
                            <th class="col-fecha text-center">18/01/2026</th>
                            <th class="col-fecha text-center">19/01/2026</th>
                            <th class="col-fecha text-center">20/01/2026</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% regroup datos_historico by area as filas_por_area %}
                        {% for area_group in filas_por_area %}
                            {% for fila in area_group.list %}
                        <tr data-activo-id="{{ fila.activo.id }}">
                            <!-- Numeración -->
                            <td class="col-numero">
                                {{ forloop.counter }}
                            </td>

                            <!-- Área -->
                            <td class="col-area">
                                <span class="area-badge {{ fila.area.nombre|lower }}">
                                    {{ fila.area.get_nombre_display }}
                                </span>
                            </td>

                            <!-- Equipo -->
                            <td class="col-equipo">
                                <strong>{{ fila.equipo.nombre }}</strong>
                            </td>

                            <!-- Activo -->
                            <td class="col-activo">
                                <strong>{{ fila.activo.nombre }}</strong>
                            </td>

                            <!-- Circuito 1: 15/01/2026 -->
                            <td class="col-fecha">
                                {% with analisis=fila.activo.analisis_vibraciones_historico.all|dictsort:"fecha_muestreo"|slice:":1" %}
                                    {% if analisis %}
                                        <span class="estado-badge {{ analisis.0.resultado }}">
                                            {{ analisis.0.get_resultado_display }}
                                        </span>
                                    {% else %}
                                        <span class="sin-datos">—</span>
                                    {% endif %}
                                {% endwith %}
                            </td>

                            <!-- Circuito 2: 16/01/2026 -->
                            <td class="col-fecha">
                                {% with analisis=fila.activo.analisis_vibraciones_historico.all|dictsort:"fecha_muestreo"|slice:"1:2" %}
                                    {% if analisis %}
                                        <span class="estado-badge {{ analisis.0.resultado }}">
                                            {{ analisis.0.get_resultado_display }}
                                        </span>
                                    {% else %}
                                        <span class="sin-datos">—</span>
                                    {% endif %}
                                {% endwith %}
                            </td>

                            <!-- Circuito 3: 17/01/2026 -->
                            <td class="col-fecha">
                                {% with analisis=fila.activo.analisis_vibraciones_historico.all|dictsort:"fecha_muestreo"|slice:"2:3" %}
                                    {% if analisis %}
                                        <span class="estado-badge {{ analisis.0.resultado }}">
                                            {{ analisis.0.get_resultado_display }}
                                        </span>
                                    {% else %}
                                        <span class="sin-datos">—</span>
                                    {% endif %}
                                {% endwith %}
                            </td>

                            <!-- Circuito 4: 18/01/2026 -->
                            <td class="col-fecha">
                                {% with analisis=fila.activo.analisis_vibraciones_historico.all|dictsort:"fecha_muestreo"|slice:"3:4" %}
                                    {% if analisis %}
                                        <span class="estado-badge {{ analisis.0.resultado }}">
                                            {{ analisis.0.get_resultado_display }}
                                        </span>
                                    {% else %}
                                        <span class="sin-datos">—</span>
                                    {% endif %}
                                {% endwith %}
                            </td>

                            <!-- Circuito 5: 19/01/2026 -->
                            <td class="col-fecha">
                                {% with analisis=fila.activo.analisis_vibraciones_historico.all|dictsort:"fecha_muestreo"|slice:"4:5" %}
                                    {% if analisis %}
                                        <span class="estado-badge {{ analisis.0.resultado }}">
                                            {{ analisis.0.get_resultado_display }}
                                        </span>
                                    {% else %}
                                        <span class="sin-datos">—</span>
                                    {% endif %}
                                {% endwith %}
                            </td>

                            <!-- Circuito 6: 20/01/2026 -->
                            <td class="col-fecha">
                                {% with analisis=fila.activo.analisis_vibraciones_historico.all|dictsort:"fecha_muestreo"|slice:"5:6" %}
                                    {% if analisis %}
                                        <span class="estado-badge {{ analisis.0.resultado }}">
                                            {{ analisis.0.get_resultado_display }}
                                        </span>
                                    {% else %}
                                        <span class="sin-datos">—</span>
                                    {% endif %}
                                {% endwith %}
                            </td>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="5" class="text-center py-5">
                                <p style="color: #999; font-size: 1.1em;">No hay activos con análisis registrados</p>
                            </td>
                        </tr>
                            {% endfor %}
                        {% endfor %}
                    </tbody>
                </table>
            </div>

        </section>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
